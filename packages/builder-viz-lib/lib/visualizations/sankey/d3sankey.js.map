{"version":3,"sources":["../../../src/visualizations/sankey/d3sankey.ts"],"names":["center","node","y","dy","value","link","Sankey","sankey","nodeWidth","nodePadding","size","nodes","links","computeNodeLinks","forEach","sourceLinks","targetLinks","source","target","push","computeNodeValues","Math","max","d3","sum","moveSinksRight","x","length","scaleNodeBreadths","kx","computeNodeBreadths","remainingNodes","nextNodes","assignBreadth","dx","indexOf","n","computeNodeDepths","iterations","nodesByBreadth","nest","key","d","sortKeys","ascending","entries","map","values","initializeNodeDepth","ky","min","i","relaxLeftToRight","alpha","weightedSource","resolveCollisions","y0","sort","ascendingDepth","relaxRightToLeft","slice","reverse","weightedTarget","a","b","computeLinkDepths","ascendingTargetDepth","ascendingSourceDepth","sy","ty","_","arguments","layout","relayout","curvature","x0","x1","xi","interpolateNumber","x2","x3","y1"],"mappings":"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","sourcesContent":["/* eslint-disable */\r\n\r\nimport d3 from \"d3\";\r\n\r\nexport interface LinkType {\r\n  id: number;\r\n  name: string;\r\n  color: string;\r\n  x: number;\r\n  y: number;\r\n  dx: number;\r\n  dy: number;\r\n  source: SourceTargetType;\r\n  target: SourceTargetType;\r\n}\r\n\r\nexport type SourceTargetType = {\r\n  sourceLinks: Array<LinkType>;\r\n  targetLinks: Array<LinkType>;\r\n};\r\n\r\nexport type NodeType = LinkType & SourceTargetType;\r\nexport interface D3SankeyType {\r\n  nodeWidth: (...args: any[]) => any;\r\n  nodeHeight: (...args: any[]) => any;\r\n  nodePadding: (...args: any[]) => any;\r\n  nodes: (...args: any[]) => any[];\r\n  link: (...args: any[]) => any;\r\n  links: (...args: any[]) => any[];\r\n  size: (...args: any[]) => any;\r\n  layout: (...args: any[]) => any;\r\n  relayout: (...args: any[]) => any;\r\n}\r\n\r\nexport type DType = { sy: number; ty: number; value: number; source: LinkType; target: LinkType } & LinkType;\r\n\r\nfunction center(node: any) {\r\n  return node.y + node.dy / 2;\r\n}\r\n\r\nfunction value(link: any) {\r\n  return link.value;\r\n}\r\n\r\nfunction Sankey(): D3SankeyType {\r\n  const sankey = {};\r\n  let nodeWidth = 24;\r\n  let nodePadding = 8;\r\n  let size = [1, 1];\r\n  let nodes: any[] = [];\r\n  let links: any[] = [];\r\n\r\n  // Populate the sourceLinks and targetLinks for each node.\r\n  // Also, if the source and target are not objects, assume they are indices.\r\n  function computeNodeLinks() {\r\n    nodes.forEach(node => {\r\n      node.sourceLinks = [];\r\n      node.targetLinks = [];\r\n    });\r\n    links.forEach(link => {\r\n      let source = link.source;\r\n      let target = link.target;\r\n      if (typeof source === \"number\") source = link.source = nodes[link.source];\r\n      if (typeof target === \"number\") target = link.target = nodes[link.target];\r\n      source.sourceLinks.push(link);\r\n      target.targetLinks.push(link);\r\n    });\r\n  }\r\n\r\n  // Compute the value (size) of each node by summing the associated links.\r\n  function computeNodeValues() {\r\n    nodes.forEach(node => {\r\n      node.value = Math.max(d3.sum(node.sourceLinks, value), d3.sum(node.targetLinks, value));\r\n    });\r\n  }\r\n\r\n  function moveSinksRight(x: any) {\r\n    nodes.forEach(node => {\r\n      if (!node.sourceLinks.length) {\r\n        node.x = x - 1;\r\n      }\r\n    });\r\n  }\r\n\r\n  function scaleNodeBreadths(kx: any) {\r\n    nodes.forEach(node => {\r\n      node.x *= kx;\r\n    });\r\n  }\r\n\r\n  // Iteratively assign the breadth (x-position) for each node.\r\n  // Nodes are assigned the maximum breadth of incoming neighbors plus one;\r\n  // nodes with no incoming links are assigned breadth zero, while\r\n  // nodes with no outgoing links are assigned the maximum breadth.\r\n  function computeNodeBreadths() {\r\n    let remainingNodes = nodes;\r\n    let nextNodes: any;\r\n    let x = 0;\r\n\r\n    function assignBreadth(node: any) {\r\n      node.x = x;\r\n      node.dx = nodeWidth;\r\n      node.sourceLinks.forEach((link: any) => {\r\n        if (nextNodes.indexOf(link.target) < 0) {\r\n          nextNodes.push(link.target);\r\n        }\r\n      });\r\n    }\r\n\r\n    while (remainingNodes.length) {\r\n      nextNodes = [];\r\n      remainingNodes.forEach(assignBreadth);\r\n      remainingNodes = nextNodes;\r\n      x += 1;\r\n    }\r\n\r\n    moveSinksRight(x);\r\n    x = Math.max(\r\n      d3.max(nodes, n => n.x),\r\n      2\r\n    ); // get new maximum x value (min 2)\r\n    scaleNodeBreadths((size[0] - nodeWidth) / (x - 1));\r\n  }\r\n\r\n  function computeNodeDepths(iterations: any) {\r\n    const nodesByBreadth = d3\r\n      // @ts-expect-error\r\n      .nest()\r\n      .key((d: any) => d.x)\r\n      .sortKeys(d3.ascending)\r\n      .entries(nodes)\r\n      .map((d: any) => d.values);\r\n\r\n    function initializeNodeDepth() {\r\n      // @ts-expect-error ts-migrate(2571) FIXME: Object is of type 'unknown'.\r\n      const ky = d3.min(nodesByBreadth, n => (size[1] - (n.length - 1) * nodePadding) / d3.sum(n, value));\r\n\r\n      nodesByBreadth.forEach((n: any) => {\r\n        n.forEach((node: any, i: any) => {\r\n          node.y = i;\r\n          // @ts-expect-error ts-migrate(2532) FIXME: Object is possibly 'undefined'.\r\n          node.dy = node.value * ky;\r\n        });\r\n      });\r\n\r\n      links.forEach(link => {\r\n        // @ts-expect-error ts-migrate(2532) FIXME: Object is possibly 'undefined'.\r\n        link.dy = link.value * ky;\r\n      });\r\n    }\r\n\r\n    function relaxLeftToRight(alpha: any) {\r\n      function weightedSource(link: any) {\r\n        return center(link.source) * link.value;\r\n      }\r\n\r\n      nodesByBreadth.forEach((n: any) => {\r\n        n.forEach((node: any) => {\r\n          if (node.targetLinks.length) {\r\n            const y = d3.sum(node.targetLinks, weightedSource) / d3.sum(node.targetLinks, value);\r\n            node.y += (y - center(node)) * alpha;\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    function resolveCollisions() {\r\n      nodesByBreadth.forEach((nodes: any) => {\r\n        const n = nodes.length;\r\n        let node;\r\n        let dy;\r\n        let y0 = 0;\r\n        let i;\r\n\r\n        // Push any overlapping nodes down.\r\n        nodes.sort(ascendingDepth);\r\n        for (i = 0; i < n; ++i) {\r\n          node = nodes[i];\r\n          dy = y0 - node.y;\r\n          if (dy > 0) node.y += dy;\r\n          y0 = node.y + node.dy + nodePadding;\r\n        }\r\n\r\n        // If the bottommost node goes outside the bounds, push it back up.\r\n        dy = y0 - nodePadding - size[1];\r\n        if (dy > 0) {\r\n          y0 = node.y -= dy;\r\n\r\n          // Push any overlapping nodes back up.\r\n          for (i = n - 2; i >= 0; --i) {\r\n            node = nodes[i];\r\n            dy = node.y + node.dy + nodePadding - y0;\r\n            if (dy > 0) node.y -= dy;\r\n            y0 = node.y;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    initializeNodeDepth();\r\n    resolveCollisions();\r\n\r\n    for (let alpha = 1; iterations > 0; iterations -= 1) {\r\n      relaxRightToLeft((alpha *= 0.99));\r\n      resolveCollisions();\r\n      relaxLeftToRight(alpha);\r\n      resolveCollisions();\r\n    }\r\n\r\n    function relaxRightToLeft(alpha: any) {\r\n      nodesByBreadth\r\n        .slice()\r\n        .reverse()\r\n        .forEach((nodes: any) => {\r\n          nodes.forEach((node: any) => {\r\n            if (node.sourceLinks.length) {\r\n              const y = d3.sum(node.sourceLinks, weightedTarget) / d3.sum(node.sourceLinks, value);\r\n              node.y += (y - center(node)) * alpha;\r\n            }\r\n          });\r\n        });\r\n\r\n      function weightedTarget(link: any) {\r\n        return center(link.target) * link.value;\r\n      }\r\n    }\r\n\r\n    function ascendingDepth(a: any, b: any) {\r\n      return a.y - b.y;\r\n    }\r\n  }\r\n\r\n  function computeLinkDepths() {\r\n    nodes.forEach(node => {\r\n      node.sourceLinks.sort(ascendingTargetDepth);\r\n      node.targetLinks.sort(ascendingSourceDepth);\r\n    });\r\n    nodes.forEach(node => {\r\n      let sy = 0,\r\n        ty = 0;\r\n      node.sourceLinks.forEach((link: any) => {\r\n        link.sy = sy;\r\n        sy += link.dy;\r\n      });\r\n      node.targetLinks.forEach((link: any) => {\r\n        link.ty = ty;\r\n        ty += link.dy;\r\n      });\r\n    });\r\n\r\n    function ascendingSourceDepth(a: any, b: any) {\r\n      return a.source.y - b.source.y;\r\n    }\r\n\r\n    function ascendingTargetDepth(a: any, b: any) {\r\n      return a.target.y - b.target.y;\r\n    }\r\n  }\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'nodeWidth' does not exist on type '{}'.\r\n  sankey.nodeWidth = function(_: any) {\r\n    if (!arguments.length) return nodeWidth;\r\n    nodeWidth = +_;\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'nodePadding' does not exist on type '{}'... Remove this comment to see the full error message\r\n  sankey.nodePadding = function(_: any) {\r\n    if (!arguments.length) return nodePadding;\r\n    nodePadding = +_;\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'nodes' does not exist on type '{}'.\r\n  sankey.nodes = function(_: any) {\r\n    if (!arguments.length) return nodes;\r\n    nodes = _;\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'links' does not exist on type '{}'.\r\n  sankey.links = function(_: any) {\r\n    if (!arguments.length) return links;\r\n    links = _;\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'size' does not exist on type '{}'.\r\n  sankey.size = function(_: any) {\r\n    if (!arguments.length) return size;\r\n    size = _;\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'layout' does not exist on type '{}'.\r\n  sankey.layout = function(iterations: any) {\r\n    computeNodeLinks();\r\n    computeNodeValues();\r\n    computeNodeBreadths();\r\n    computeNodeDepths(iterations);\r\n    computeLinkDepths();\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'relayout' does not exist on type '{}'.\r\n  sankey.relayout = function() {\r\n    computeLinkDepths();\r\n    return sankey;\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2339) FIXME: Property 'link' does not exist on type '{}'.\r\n  sankey.link = function() {\r\n    let curvature = 0.5;\r\n\r\n    function link(d: DType) {\r\n      const x0 = d.source.x + d.source.dx;\r\n      const x1 = d.target.x;\r\n      const xi = d3.interpolateNumber(x0, x1);\r\n      const x2 = xi(curvature);\r\n      const x3 = xi(1 - curvature);\r\n      const y0 = d.source.y + d.sy + d.dy / 2;\r\n      const y1 = d.target.y + d.ty + d.dy / 2;\r\n\r\n      return `M${x0},${y0}C${x2},${y0} ${x3},${y1} ${x1},${y1}`;\r\n    }\r\n\r\n    link.curvature = (_: any) => {\r\n      if (!arguments.length) return curvature;\r\n      curvature = +_;\r\n      return link;\r\n    };\r\n\r\n    return link;\r\n  };\r\n\r\n  return sankey as D3SankeyType;\r\n}\r\n\r\nexport default Sankey;\r\n"],"file":"d3sankey.js"}