{"version":3,"sources":["../../../../src/visualizations/chart/Renderer/initChart.ts"],"names":["createErrorHandler","errorHandler","error","initPlotUpdater","actions","updater","append","action","push","process","plotlyElement","length","updates","handlers","Plotly","relayout","then","handler","Promise","resolve","initChart","container","options","data","additionalOptions","onError","handleError","plotlyOptions","showLink","displaylogo","hidePlotlyModeBar","displayModeBar","plotlyData","plotlyLayout","isDestroyed","createSafeFunction","fn","unwatchResize","promise","newPlot","on","visible","onHover","onUnHover","catch","result","initialized","setZoomEnabled","allowZoom","layoutUpdates","dragmode","destroy","removeAllListeners","__previousSize","purge"],"mappings":"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","sourcesContent":["import { isArray, isObject, isString, isFunction, startsWith, reduce, merge, map, each } from \"lodash\";\r\nimport resizeObserver from \"@/services/resizeObserver\";\r\nimport { Plotly, prepareData, prepareLayout, updateData, updateAxes, updateChartSize } from \"../plotly\";\r\n\r\nfunction createErrorHandler(errorHandler: any) {\r\n  return (error: any) => {\r\n    // This error happens only when chart width is 20px and looks that\r\n    // it's safe to just ignore it: 1px less or more and chart will get fixed.\r\n    if (isString(error) && startsWith(error, \"ax.dtick error\")) {\r\n      return;\r\n    }\r\n    errorHandler(error);\r\n  };\r\n}\r\n\r\n// This utility is intended to reduce amount of plot updates when multiple Plotly.relayout\r\n// calls needed in order to compute/update the plot.\r\n// `.append()` method takes an array of two element: first one is a object with updates for layout,\r\n// and second is an optional function that will be called when plot is updated. That function may\r\n// return an array with same structure if further updates needed.\r\n// `.process()` merges all updates into a single object and calls `Plotly.relayout()`. After that\r\n// it calls all callbacks, collects their return values and does another loop if needed.\r\nfunction initPlotUpdater() {\r\n  let actions: any = [];\r\n\r\n  const updater = {\r\n    append(action: any) {\r\n      if (isArray(action) && isObject(action[0])) {\r\n        actions.push(action);\r\n      }\r\n      return updater;\r\n    },\r\n    // @ts-expect-error ts-migrate(7023) FIXME: 'process' implicitly has return type 'any' because... Remove this comment to see the full error message\r\n    process(plotlyElement: any) {\r\n      if (actions.length > 0) {\r\n        const updates = reduce(actions, (updates, action) => merge(updates, action[0]), {});\r\n        const handlers = map(actions, action => (isFunction(action[1]) ? action[1] : () => null));\r\n        actions = [];\r\n        return Plotly.relayout(plotlyElement, updates).then(() => {\r\n          each(handlers, handler => updater.append(handler()));\r\n          return updater.process(plotlyElement);\r\n        });\r\n      } else {\r\n        return Promise.resolve();\r\n      }\r\n    },\r\n  };\r\n\r\n  return updater;\r\n}\r\n\r\nexport default function initChart(container: any, options: any, data: any, additionalOptions: any, onError: any) {\r\n  const handleError = createErrorHandler(onError);\r\n\r\n  const plotlyOptions = {\r\n    showLink: false,\r\n    displaylogo: false,\r\n  };\r\n\r\n  if (additionalOptions.hidePlotlyModeBar) {\r\n    // @ts-expect-error ts-migrate(2339) FIXME: Property 'displayModeBar' does not exist on type '... Remove this comment to see the full error message\r\n    plotlyOptions.displayModeBar = false;\r\n  }\r\n\r\n  const plotlyData = prepareData(data, options);\r\n  const plotlyLayout = prepareLayout(container, options, plotlyData);\r\n\r\n  let isDestroyed = false;\r\n\r\n  let updater = initPlotUpdater();\r\n\r\n  function createSafeFunction(fn: any) {\r\n    // @ts-expect-error ts-migrate(7019) FIXME: Rest parameter 'args' implicitly has an 'any[]' ty... Remove this comment to see the full error message\r\n    return (...args) => {\r\n      if (!isDestroyed) {\r\n        try {\r\n          return fn(...args);\r\n        } catch (error) {\r\n          handleError(error);\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  let unwatchResize = () => {};\r\n\r\n  const promise = Promise.resolve()\r\n    .then(() => Plotly.newPlot(container, plotlyData, plotlyLayout, plotlyOptions))\r\n    .then(\r\n      createSafeFunction(() =>\r\n        updater\r\n          .append(updateAxes(container, plotlyData, plotlyLayout, options))\r\n          .append(updateChartSize(container, plotlyLayout, options))\r\n          .process(container)\r\n      )\r\n    )\r\n    .then(\r\n      createSafeFunction(() => {\r\n        container.on(\r\n          \"plotly_restyle\",\r\n          createSafeFunction((updates: any) => {\r\n            // This event is triggered if some plotly data/layout has changed.\r\n            // We need to catch only changes of traces visibility to update stacking\r\n            // @ts-expect-error ts-migrate(2339) FIXME: Property 'visible' does not exist on type 'object'... Remove this comment to see the full error message\r\n            if (isArray(updates) && isObject(updates[0]) && updates[0].visible) {\r\n              updateData(plotlyData, options);\r\n              updater.append(updateAxes(container, plotlyData, plotlyLayout, options)).process(container);\r\n            }\r\n          })\r\n        );\r\n        options.onHover && container.on(\"plotly_hover\", options.onHover);\r\n        options.onUnHover && container.on(\"plotly_unhover\", options.onUnHover);\r\n\r\n        unwatchResize = resizeObserver(\r\n          container,\r\n          createSafeFunction(() => {\r\n            updater.append(updateChartSize(container, plotlyLayout, options)).process(container);\r\n          })\r\n        );\r\n      })\r\n    )\r\n    .catch(handleError);\r\n\r\n  // @ts-expect-error ts-migrate(7022) FIXME: 'result' implicitly has type 'any' because it does... Remove this comment to see the full error message\r\n  const result = {\r\n    initialized: promise.then(() => result),\r\n    setZoomEnabled: createSafeFunction((allowZoom: any) => {\r\n      const layoutUpdates = { dragmode: allowZoom ? \"zoom\" : false };\r\n      // @ts-expect-error ts-migrate(2345) FIXME: Argument of type '{ dragmode: string | boolean; }'... Remove this comment to see the full error message\r\n      return Plotly.relayout(container, layoutUpdates);\r\n    }),\r\n    destroy: createSafeFunction(() => {\r\n      isDestroyed = true;\r\n      container.removeAllListeners(\"plotly_restyle\");\r\n      unwatchResize();\r\n      delete container.__previousSize; // added by `updateChartSize`\r\n      Plotly.purge(container);\r\n    }),\r\n  };\r\n\r\n  return result;\r\n}\r\n"],"file":"initChart.js"}