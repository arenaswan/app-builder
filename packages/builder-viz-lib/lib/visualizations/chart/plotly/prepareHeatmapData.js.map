{"version":3,"sources":["../../../../src/visualizations/chart/plotly/prepareHeatmapData.ts"],"names":["defaultColorScheme","prepareSeries","series","options","additionalOptions","colorScheme","formatNumber","plotlySeries","x","y","z","type","name","colorscale","data","v","sortX","sortY","reverseX","reverse","reverseY","zMax","d","zVal","dataLabels","mode","hoverinfo","showlegend","text","textfont","color","i","length","item","j","datum","zValue","push","isFinite","showDataLabels","prepareHeatmapData","seriesList","heatMinColor","heatMaxColor","numberFormat"],"mappings":"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","sourcesContent":["import { map, max, uniq, sortBy, flatten, find } from \"lodash\";\r\nimport { createNumberFormatter } from \"@/lib/value-format\";\r\n\r\nconst defaultColorScheme = [\r\n  [0, \"#356aff\"],\r\n  [0.14, \"#4a7aff\"],\r\n  [0.28, \"#5d87ff\"],\r\n  [0.42, \"#7398ff\"],\r\n  [0.56, \"#fb8c8c\"],\r\n  [0.71, \"#ec6463\"],\r\n  [0.86, \"#ec4949\"],\r\n  [1, \"#e92827\"],\r\n];\r\n\r\nfunction prepareSeries(series: any, options: any, additionalOptions: any) {\r\n  const { colorScheme, formatNumber } = additionalOptions;\r\n\r\n  const plotlySeries = {\r\n    x: [],\r\n    y: [],\r\n    z: [],\r\n    type: \"heatmap\",\r\n    name: \"\",\r\n    colorscale: colorScheme,\r\n  };\r\n\r\n  // @ts-expect-error ts-migrate(2322) FIXME: Type 'any[]' is not assignable to type 'never[]'.\r\n  plotlySeries.x = uniq(map(series.data, v => v.x));\r\n  // @ts-expect-error ts-migrate(2322) FIXME: Type 'any[]' is not assignable to type 'never[]'.\r\n  plotlySeries.y = uniq(map(series.data, v => v.y));\r\n\r\n  if (options.sortX) {\r\n    plotlySeries.x = sortBy(plotlySeries.x);\r\n  }\r\n\r\n  if (options.sortY) {\r\n    plotlySeries.y = sortBy(plotlySeries.y);\r\n  }\r\n\r\n  if (options.reverseX) {\r\n    plotlySeries.x.reverse();\r\n  }\r\n\r\n  if (options.reverseY) {\r\n    plotlySeries.y.reverse();\r\n  }\r\n\r\n  const zMax = max(map(series.data, d => d.zVal));\r\n\r\n  // Use text trace instead of default annotation for better performance\r\n  const dataLabels = {\r\n    x: [],\r\n    y: [],\r\n    mode: \"text\",\r\n    hoverinfo: \"skip\",\r\n    showlegend: false,\r\n    text: [],\r\n    textfont: {\r\n      color: [],\r\n    },\r\n  };\r\n\r\n  for (let i = 0; i < plotlySeries.y.length; i += 1) {\r\n    const item = [];\r\n    for (let j = 0; j < plotlySeries.x.length; j += 1) {\r\n      const datum = find(series.data, { x: plotlySeries.x[j], y: plotlySeries.y[i] });\r\n\r\n      const zValue = (datum && datum.zVal) || 0;\r\n      item.push(zValue);\r\n\r\n      if (isFinite(zMax) && options.showDataLabels) {\r\n        dataLabels.x.push(plotlySeries.x[j]);\r\n        dataLabels.y.push(plotlySeries.y[i]);\r\n        // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'any' is not assignable to parame... Remove this comment to see the full error message\r\n        dataLabels.text.push(formatNumber(zValue));\r\n        if (options.colorScheme && options.colorScheme === \"Custom...\") {\r\n          // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'string' is not assignable to par... Remove this comment to see the full error message\r\n          dataLabels.textfont.color.push(\"white\");\r\n        } else {\r\n          // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'string' is not assignable to par... Remove this comment to see the full error message\r\n          dataLabels.textfont.color.push(zValue / zMax < 0.25 ? \"white\" : \"black\");\r\n        }\r\n      }\r\n    }\r\n    // @ts-expect-error ts-migrate(2345) FIXME: Argument of type 'any[]' is not assignable to para... Remove this comment to see the full error message\r\n    plotlySeries.z.push(item);\r\n  }\r\n\r\n  if (isFinite(zMax) && options.showDataLabels) {\r\n    return [plotlySeries, dataLabels];\r\n  }\r\n  return [plotlySeries];\r\n}\r\n\r\nexport default function prepareHeatmapData(seriesList: any, options: any) {\r\n  let colorScheme = [];\r\n\r\n  if (!options.colorScheme) {\r\n    colorScheme = defaultColorScheme;\r\n  } else if (options.colorScheme === \"Custom...\") {\r\n    colorScheme = [\r\n      [0, options.heatMinColor],\r\n      [1, options.heatMaxColor],\r\n    ];\r\n  } else {\r\n    colorScheme = options.colorScheme;\r\n  }\r\n\r\n  const additionalOptions = {\r\n    colorScheme,\r\n    formatNumber: createNumberFormatter(options.numberFormat),\r\n  };\r\n\r\n  return flatten(map(seriesList, series => prepareSeries(series, options, additionalOptions)));\r\n}\r\n"],"file":"prepareHeatmapData.js"}