{"version":3,"sources":["../../../../src/visualizations/chart/plotly/prepareDefaultData.ts"],"names":["getSeriesColor","seriesOptions","seriesIndex","color","ColorPaletteArray","length","getHoverInfoPattern","options","hasX","test","textFormat","hasName","result","prepareBarSeries","series","additionalOptions","type","offsetgroup","index","showDataLabels","textposition","prepareLineSeries","mode","prepareAreaSeries","fill","stacking","prepareScatterSeries","prepareBubbleSeries","seriesColor","data","coefficient","marker","size","i","sizemode","prepareBoxSeries","boxpoints","hoverinfo","showpoints","jitter","pointpos","prepareSeries","hoverInfoPattern","globalSeriesType","yAxis","name","seriesYAxis","sortX","d","x","xAxis","cleanYValue","normalizeValue","v","missingValuesAsZero","sourceData","Map","xValues","yValues","yErrorValues","row","y","yError","set","yPercent","push","plotlySeries","visible","error_y","array","insidetextfont","yaxis","prepareDefaultData","seriesList"],"mappings":"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","sourcesContent":["import { isNil, extend, each, includes, map, sortBy, toString } from \"lodash\";\r\nimport chooseTextColorForBackground from \"@/lib/chooseTextColorForBackground\";\r\nimport { ColorPaletteArray } from \"@/visualizations/ColorPalette\";\r\nimport { cleanNumber, normalizeValue, getSeriesAxis } from \"./utils\";\r\n\r\nfunction getSeriesColor(seriesOptions: any, seriesIndex: any) {\r\n  return seriesOptions.color || ColorPaletteArray[seriesIndex % ColorPaletteArray.length];\r\n}\r\n\r\nfunction getHoverInfoPattern(options: any) {\r\n  const hasX = /{{\\s*@@x\\s*}}/.test(options.textFormat);\r\n  const hasName = /{{\\s*@@name\\s*}}/.test(options.textFormat);\r\n  let result = \"text\";\r\n  if (!hasX) result += \"+x\";\r\n  if (!hasName) result += \"+name\";\r\n  return result;\r\n}\r\n\r\nfunction prepareBarSeries(series: any, options: any, additionalOptions: any) {\r\n  series.type = \"bar\";\r\n  series.offsetgroup = toString(additionalOptions.index);\r\n  if (options.showDataLabels) {\r\n    series.textposition = \"inside\";\r\n  }\r\n  return series;\r\n}\r\n\r\nfunction prepareLineSeries(series: any, options: any) {\r\n  series.mode = \"lines\" + (options.showDataLabels ? \"+text\" : \"\");\r\n  return series;\r\n}\r\n\r\nfunction prepareAreaSeries(series: any, options: any) {\r\n  series.mode = \"lines\" + (options.showDataLabels ? \"+text\" : \"\");\r\n  series.fill = options.series.stacking ? \"tonexty\" : \"tozeroy\";\r\n  return series;\r\n}\r\n\r\nfunction prepareScatterSeries(series: any, options: any) {\r\n  series.type = \"scatter\";\r\n  series.mode = \"markers\" + (options.showDataLabels ? \"+text\" : \"\");\r\n  return series;\r\n}\r\n\r\nfunction prepareBubbleSeries(series: any, options: any, { seriesColor, data }: any) {\r\n  const coefficient = options.coefficient || 1;\r\n  series.mode = \"markers\";\r\n  series.marker = {\r\n    color: seriesColor,\r\n    size: map(data, i => i.size * coefficient),\r\n    sizemode: options.sizemode || \"diameter\",\r\n  };\r\n  return series;\r\n}\r\n\r\nfunction prepareBoxSeries(series: any, options: any, { seriesColor }: any) {\r\n  series.type = \"box\";\r\n  series.mode = \"markers\";\r\n\r\n  series.boxpoints = \"outliers\";\r\n  series.hoverinfo = false;\r\n  series.marker = {\r\n    color: seriesColor,\r\n    size: 3,\r\n  };\r\n  if (options.showpoints) {\r\n    series.boxpoints = \"all\";\r\n    series.jitter = 0.3;\r\n    series.pointpos = -1.8;\r\n  }\r\n  return series;\r\n}\r\n\r\nfunction prepareSeries(series: any, options: any, additionalOptions: any) {\r\n  const { hoverInfoPattern, index } = additionalOptions;\r\n\r\n  const seriesOptions = extend({ type: options.globalSeriesType, yAxis: 0 }, options.seriesOptions[series.name]);\r\n  const seriesColor = getSeriesColor(seriesOptions, index);\r\n  const seriesYAxis = getSeriesAxis(series, options);\r\n\r\n  // Sort by x - `Map` preserves order of items\r\n  const data = options.sortX ? sortBy(series.data, d => normalizeValue(d.x, options.xAxis.type)) : series.data;\r\n\r\n  // For bubble/scatter charts `y` may be any (similar to `x`) - numeric is only bubble size;\r\n  // for other types `y` is always number\r\n  const cleanYValue = includes([\"bubble\", \"scatter\"], seriesOptions.type)\r\n    ? normalizeValue\r\n    : (v: any) => {\r\n        v = cleanNumber(v);\r\n        return options.missingValuesAsZero && isNil(v) ? 0.0 : v;\r\n      };\r\n\r\n  const sourceData = new Map();\r\n  const xValues: any = [];\r\n  const yValues: any = [];\r\n  const yErrorValues: any = [];\r\n  each(data, row => {\r\n    const x = normalizeValue(row.x, options.xAxis.type); // number/datetime/category\r\n    const y = cleanYValue(row.y, seriesYAxis === \"y2\" ? options.yAxis[1].type : options.yAxis[0].type); // depends on series type!\r\n    const yError = cleanNumber(row.yError); // always number\r\n    const size = cleanNumber(row.size); // always number\r\n    sourceData.set(x, {\r\n      x,\r\n      y,\r\n      yError,\r\n      size,\r\n      yPercent: null, // will be updated later\r\n      row,\r\n    });\r\n    xValues.push(x);\r\n    yValues.push(y);\r\n    yErrorValues.push(yError);\r\n  });\r\n\r\n  const plotlySeries = {\r\n    visible: true,\r\n    hoverinfo: hoverInfoPattern,\r\n    x: xValues,\r\n    y: yValues,\r\n    error_y: {\r\n      array: yErrorValues,\r\n      color: seriesColor,\r\n    },\r\n    name: seriesOptions.name || series.name,\r\n    marker: { color: seriesColor },\r\n    insidetextfont: {\r\n      color: chooseTextColorForBackground(seriesColor),\r\n    },\r\n    yaxis: seriesYAxis,\r\n    sourceData,\r\n  };\r\n\r\n  additionalOptions = { ...additionalOptions, seriesColor, data };\r\n\r\n  switch (seriesOptions.type) {\r\n    case \"column\":\r\n      return prepareBarSeries(plotlySeries, options, additionalOptions);\r\n    case \"line\":\r\n      // @ts-expect-error ts-migrate(2554) FIXME: Expected 2 arguments, but got 3.\r\n      return prepareLineSeries(plotlySeries, options, additionalOptions);\r\n    case \"area\":\r\n      // @ts-expect-error ts-migrate(2554) FIXME: Expected 2 arguments, but got 3.\r\n      return prepareAreaSeries(plotlySeries, options, additionalOptions);\r\n    case \"scatter\":\r\n      // @ts-expect-error ts-migrate(2554) FIXME: Expected 2 arguments, but got 3.\r\n      return prepareScatterSeries(plotlySeries, options, additionalOptions);\r\n    case \"bubble\":\r\n      return prepareBubbleSeries(plotlySeries, options, additionalOptions);\r\n    case \"box\":\r\n      return prepareBoxSeries(plotlySeries, options, additionalOptions);\r\n    default:\r\n      return plotlySeries;\r\n  }\r\n}\r\n\r\nexport default function prepareDefaultData(seriesList: any, options: any) {\r\n  const additionalOptions = {\r\n    hoverInfoPattern: getHoverInfoPattern(options),\r\n  };\r\n\r\n  return map(seriesList, (series, index) => prepareSeries(series, options, { ...additionalOptions, index }));\r\n}\r\n"],"file":"prepareDefaultData.js"}